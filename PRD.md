# 局域网房主服务器版剧本杀（单房间）

## 1. 整体架构

- 部署形态  
  - 房主端：运行「服务器 + 房主客户端」二合一程序，负责维护全局游戏状态（剧本、阶段、投票、结果等）。  
  - 玩家端：仅做 UI 展示和本地交互，通过局域网连接房主服务器，同步当前房间状态，默认玩家数量区间为 4–6。  

- 房间模型  
  - 永远只有一个房间，无“多房间列表”“房间 ID”“创建/加入房间”概念。  
  - 同一时刻仅允许一个对局实例运行。  
  - 所有协议与状态都围绕这一个 `GameRoom` 实例。  

- 网络与运行环境  
  - 运行环境：Windows 桌面应用。  
  - 通信方式：局域网 TCP（命令与状态），可选 UDP 心跳。  
  - 无公网依赖，所有玩家在同一局域网内即可。  
  - 技术栈：PyQt5（客户端 UI）+ Python 后端（房主服务器）。  

---

## 2. 逻辑模型与状态机

### 2.1 核心实体

- `GameRoom`（唯一实例）  
  - `scriptId`：当前剧本 ID。  
  - `players`：玩家列表（含座位号/角色编号、玩家显示名、连接状态）。  
  - `phase`：当前大阶段（Config / Reading / Investigation / Voting / ResultReview / Archived）。  
  - `subPhase`：阶段内子状态（如搜证轮次、是否已公开某些线索）。  
  - `votes`：各轮投票记录与统计结果。  
  - `logs`：本局操作日志（搜证记录、投票记录、阶段推进时间点等）。  

- `Player`  
  - `playerId`：连接对应的唯一 ID。  
  - `displayName`：玩家自定义昵称。  
  - `roleId`：抽到的角色编号（对应剧本中的 `roles.id`）。  
  - `isHost`：是否为房主。  
  - `connected`：是否在线。  
  - `currentVote`：当前轮的投票对象。  

### 2.2 状态机（由房主服务器维护）

- `Idle`  
  - 无正在进行的对局，等待房主选择剧本、设置玩家人数（默认 4–6）。  

- `Configuring`（游戏配置）  
  - 房主选择剧本文件。  
  - 设置参与人数（默认 4–6）。  
  - 执行随机角色编号分配，玩家可修改显示名。  

- `Reading`（剧本阅读阶段）  
  - 每个客户端只能查看自己角色视角的剧本内容。  
  - 支持分页或段落跳转。  

- `Investigation`（搜证阶段）  
  - 支持普通搜索和深度搜证（依据线索 `type` 控制）。  
  - 可设计为多轮搜证，每轮可限制可选线索数。  

- `Voting`（投票阶段）  
  - 所有玩家对候选人进行投票。  
  - 服务器负责统计与合法校验（如一人一票）。  

- `ResultReview`（结果与复盘阶段）  
  - 展示真相、事件时间线、投票结果、搜证记录等。  

- `Archived / Reset`  
  - 结束状态，可将本局存档到本地，或一键重置开始下一局（仍然使用同一个房间）。  

---

## 3. 房主端与客户端职责划分

### 3.1 房主服务器职责

- 剧本管理  
  - 从 `data/scripts/` 读取并解析 JSON 剧本文件。  
  - 抽取 `roles / events / clues / truth` 等字段，构建内存模型。  

- 房间与玩家管理  
  - 初始化唯一 `GameRoom`。  
  - 管理玩家连接、断线重连、座位/角色绑定。  
  - 执行随机角色编号分配，记录到 `GameRoom.players[*].roleId`。  

- 流程与规则裁决  
  - 负责推进状态机（阶段切换）。  
  - 判断玩家操作是否合法（是否在当前阶段、是否有权限查看某线索等）。  
  - 在搜证和投票阶段，对请求进行裁决并广播结果。  

- 存档与复盘  
  - 存档能力待定，先预留接口。  

### 3.2 玩家客户端职责

- 显示当前房间与玩家状态  
  - 房间基本信息：剧本标题、当前阶段、当前轮次等。  
  - 玩家列表：昵称、座位/角色编号、在线状态（无真实身份标识）。  

- 提交操作请求  
  - 修改玩家昵称。  
  - 准备状态切换（Ready）。  
  - 阅读剧本时的翻页请求。  
  - 搜证请求（普通 / 深度）。  
  - 投票提交。  

- 接受并展示结果  
  - 服务器推送的线索内容、投票统计、结果与真相。  
  - 仅展示与自己/当前阶段相关的内容。  

---

## 4. 界面与模块设计

### 4.1 公共模块（所有客户端）

- 首页  
  - 显示“房主地址/本机房主状态”。  
  - 玩家端提供手动输入房主 IP/端口的连接框。  
  - 按钮：`开始游戏`（房主） / `连接房主`（玩家）。  

- 游戏主界面（顶部统一展示房间状态）  
  - 顶部状态栏：剧本标题、当前阶段、当前人数。  
  - 左侧玩家列表：玩家昵称、角色编号（可控制是否显示）、在线状态。  
  - 主区域根据阶段切换不同子界面。  

- 各阶段子界面  
  - 剧本阅读：角色视角内容展示，分页、滚动、章节。  
  - 搜证：线索列表（普通 / 深度），线索详情弹窗或右侧面板。  
  - 投票：候选人列表、已选对象提示、投票锁定与倒计时（可选）。  
  - 结果与复盘：真相文本、事件时间线、投票统计图表（文本版即可）、搜证记录列表。  

### 4.2 房主端额外界面

- 房间状态面板  
  - 当前房间状态：等待开始 / 游戏中 / 已结束。  
  - 当前连接玩家数 / 配置最大玩家数。  

- 游戏控制面板  
  - 剧本选择：从本机 `data/scripts/` 中选择 JSON 文件。  
  - 人数设定与角色分配：默认 4–6 人，执行随机分配，必要时重置。  
  - 阶段控制：按钮 `开始游戏`、`下一阶段`、`结束本局`。  
  - 存档控制：`保存当前进度`、`从存档恢复`。  

---

## 5. 数据与文件组织

### 5.1 服务器本地文件结构

- `data/scripts/`  
  - 存放剧本 JSON 文件，格式建议：  
    ```json
    {
      "id": "script_001",
      "title": "示例剧本",
      "summary": "一句话概述",
      "roles": [
        { "id": 1, "name": "角色A", "intro": "人物简介", "story": "角色视角剧本" }
      ],
      "events": [
        { "id": "e1", "time": "20:00", "content": "事件描述" }
      ],
      "clues": [
        { "id": "c1", "name": "线索1", "type": "normal", "content": "线索内容" }
      ],
      "truth": "真相与复盘内容"
    }
    ```  

- `data/saves/`（待定）  
  - 存放本局存档与历史对局记录（可采用 JSON）。  
  - 记录：剧本 ID、玩家列表、分配结果、阶段、线索公开情况、投票记录、最终结果等。  

- `assets/`（可选）  
  - 剧本封面、图标、配图等资源。  
  - 可由服务器统一管理路径，客户端按需请求。  

### 5.2 剧本与玩家映射规则

- `roles.id` 作为抽取编号  
  - 房主服务器在 `Configuring` 阶段完成随机分配。  
  - 分配结果写入 `GameRoom.players[*].roleId`。  
  - 玩家可修改自己的显示昵称，但不改变其对应的 `roleId`。  

- 线索 `type` 字段  
  - `normal`：普通搜证可获取。  
  - `deep`：深度搜证触发或特殊条件下才可获取。  

---

## 6. 通信协议（单房间简化版）

> 以下是逻辑事件名称，不限定具体传输格式（可用 JSON）。

### 6.1 连接与注册

- `Connect`（C → S）  
  - 参数：`hostIp`、`hostPort`、`displayName`（可选初始昵称）。  

- `PlayerJoined`（S → All）  
  - 内容：最新玩家列表（`playerId`、`displayName`、`isHost`、`connected`）。  

### 6.2 配置与开局

- `ConfigUpdate`（S → All）  
  - 当前剧本标题、最大人数、已连接人数、角色分配情况（可控制是否向所有人公开）。  

- `StartGame`（Host 操作 → S，S → All）  
  - 服务器切换 `GameRoom.phase` 至 `Reading`，推送最新 `StateUpdate`。  

### 6.3 阶段内交互

- 剧本阅读  
  - `RequestRoleScript`（C → S）：请求自己角色的剧本内容或某一分页。  
  - `RoleScriptData`（S → C）：返回可见剧本文本。  

- 搜证  
  - `RequestSearch`（C → S）：请求普通或深度搜证。  
  - `SearchResult`（S → C 或 S → All）：返回新线索列表或单条线索详情。  

- 投票  
  - `SubmitVote`（C → S）：提交被投对象 `playerId`。  
  - `VoteStatusUpdate`（S → All）：全局投票进度（已投人数、是否结束）。  

### 6.4 阶段推进与结果

- `StateUpdate`（S → All）  
  - 当前阶段、子阶段、阶段剩余时间（可选）、可见线索、已公开的事件时间线片段等。  

- `GameResult`（S → All）  
  - 真相文本、完整事件时间线、最终投票统计、凶手/关键角色标注。  

---

## 7. 非目标与约束（沿用并细化）

- 不做：  
  - 多房间、多房主、多剧本同时在线。  
  - 账号体系、登录注册、云端存档。  
  - 语音聊天、文字聊天、实时语音连麦。  
  - 公网匹配、跨 NAT 打洞等复杂网络方案。  

- 约束：  
  - 仅支持局域网内连接同一房主服务器。  
  - 不依赖数据库，所有数据基于本地文件（JSON）与内存状态。  
  - UI 采用 Windows 桌面窗口形式（WinForms/WPF/PyQt/Electron 等任选）。  
